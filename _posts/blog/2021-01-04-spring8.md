---
layout: post
title: "[인프런] 스프링 입문 - 스프링 DB 접근 기술"
date: 2021-01-04
category: blog
---

## [인프런] 스프링 입문 - 스프링 DB 접근 기술

### 1. H2 데이터베이스 설치

- jdbc url

 \- jdbc:h2:tcp://localhost/~/test
 
 - ddl
```sql
drop table if exists member CASCADE;
create table member
(
 id bigint generated by default as identity, //자동생성
 name varchar(255),
 primary key (id)
);
```
- dml
```sql
insert into member(name) values('spring)
```

- 프로젝트 루트에 sql 디렉토리 생성해서 쿼리문 관리하기

<br>

### 2. 순수 JDBC

- 수업때 배웠던 전통적인 JDBC 방식, 참고만

- 추억의 datasource, preparedStatement, connection...

- Config 파일만 변경해서 연결 가능

- 개방-폐쇄 원칙(OCP, Open-Closed Priniple) : 확장에는 열려있고, 수정 변경에는 닫혀있다 (다형성)

- 스프링의 DI를 사용하면, 기존 코드를 전혀 손대지 않고, 설정만으로 구현 클래스를 변경 할 수 있다

<br>

### 3. 스프링 통합 테스트

스프링 컨테이너와 DB를 연결한 통합 테스트

- @SpringBootTest , @Transactional - rollback 을 해줘서 db 반영x

- service, repository(memory->member변경) 모두 @autowired

- @AfterEach 메소드 삭제

- 주로 test 전용 db 따로 구축함

- 스프링 없이도 할 수 있는 단위 테스트 잘 만드는 것이 중요

<br>

### 4. 스프링 Jdbc Template

- myBatis와 비슷한 라이브러리

- JDBC API에서 반복 코드 대부분 제거

- SQL은 직접 작성

- SimpleJdbcInsert 를 사용하면 쿼리문 작성 필요 x
```java
  @Override
    public Member save(Member member) {
        SimpleJdbcInsert jdbcInsert = new SimpleJdbcInsert(jdbcTemplate);
        jdbcInsert.withTableName("member").usingGeneratedKeyColumns("id");

        Map<String, Object> parameters = new HashMap<>();
        parameters.put("name", member.getName());

        Number key = jdbcInsert.executeAndReturnKey(new MapSqlParameterSource(parameters));
        member.setId(key.longValue());
        
        return member;
```


<br>

### 5. JPA

> Java Persistance API

- JPA 는 기존 반복코드와 SQL 을 직접 만들어준다

- SQL, 데이터 중심 설계 --> 객체 중심 설계

- ORM 기술 

- Entity Manager 주입

- JPQL(객체지향쿼리)

- Spring config 에 Entity Manager 주입, Repository 리턴값 변경
```java
  @Bean
    public MemberRepository memberRepository() {
        return new JpaMemberRepository(em);
    }
```


<br>

### 6. 스프링 데이터 JPA

- 리포지토리에 구현 클래스 없이 인터페이스 만으로 개발 완료 가능 (기본 CRUD 제공)

- findByName(),findByEmail() 처럼 메서드 이름만으로 조회 기능 제공

- interface - interface : extends 사용

- 복잡한 동적 쿼리: Querydsl 라이브러리 

- 네이티브 쿼리, JsbcTemplate, MyBatis 사용



